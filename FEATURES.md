# WeatherPulse - Feature Specification

## Project Overview
A modern, highly configurable weather card for Home Assistant with dynamic theming, animated icons, and intelligent contextual information.

---

## Core Features

### 1. Dynamic Header Modes
- [x] **Time-Focused**: Large time, small date âœ…
- [x] **Date-Focused**: Large date, small time âœ…
- [x] **Balanced**: Equal prominence time/date âœ…
- [x] **Minimal**: Just weather icon + temp âœ…
- [x] **Greeting Mode**: Personalized contextual greetings âœ…
  - Time-based (Morning/Afternoon/Evening/Night) âœ…
  - Weather-aware suggestions ("Grab an umbrella!") âœ…
  - Temperature-aware ("Bundle up!") âœ…
  - Configurable user name âœ…
- [x] **Graphical Header**: Beautiful seasonal imagery âœ…
  - Spring: Cherry blossoms & tulips (bundled) âœ…
  - Summer: Tropical beach sunset (bundled) âœ…
  - Fall: Autumn pumpkin & maple leaves (bundled) âœ…
  - Winter: Snowy winter beach (bundled) âœ…
  - Multiple bundled images per season (9 total included) âœ…
  - Custom image support via seasonal_images config âœ…
  - Auto-switching based on season (Mar-May, Jun-Aug, Sep-Nov, Dec-Feb) âœ…
  - Dark gradient overlay for text readability âœ…
  - Weather icon positioned on left (consistent with all other header modes) âœ…
  - Dropdown selector in visual editor for easy image selection âœ…

### 2. Temperature-Based Header Highlighting (Signature Feature)
- [x] Dynamic gradient background based on actual outdoor temp âœ…
  - `< 32Â°F`: Icy blues/purples âœ…
  - `32-50Â°F`: Cool blues/teals âœ…
  - `50-70Â°F`: Pleasant greens/yellows âœ…
  - `70-85Â°F`: Warm oranges âœ…
  - `> 85Â°F`: Hot reds/deep oranges âœ…
- [x] Seasonal theme variants (done via Graphical Header seasonal images) âœ…
- [x] Pulsing glow effect for extreme temperatures (>=95Â°F hot, <=20Â°F freezing) âœ…
- [x] Heat warnings and freeze alerts visual indicators (glowing card border) âœ…

### 3. Dual Temperature Display
- [x] Show both **forecast temp** AND **actual outdoor sensor temp** âœ…
- [ ] Visual indicator when temps differ significantly (PLANNED)
- [x] "Feels like" temperature display (calculated or from provider) âœ…
- [x] Configurable sensor selection for actual temp âœ…

### 4. Weather Information Display
- [x] **UV Index** display âœ…
- [x] **Wind** speed and gusts âœ…
- [x] **Feels Like** temperature âœ…
- [x] **Precipitation** (when active) âœ…
- [x] **Humidity** percentage âœ…
- [x] **Atmospheric Pressure** âœ…
- [x] **Visibility** distance âœ…
- [x] **Sunrise/Sunset** times with auto-switching âœ…
- [x] Three layout modes: Compact (in header), Standard (cards), Detailed (large cards) âœ…

### 5. View Modes
- [x] **Compact**: Current + minimal forecast (horizontal scroll for hourly) âœ…
- [x] **Standard**: Current + detailed daily (2-column for hourly) âœ…
- [x] **Detailed**: Current + daily with extra info (humidity, wind for hourly) âœ…
- [x] **Chart**: TV-style temperature trend line visualization âœ…
  - Day names displayed at top âœ…
  - Temperature values positioned on trend lines âœ…
  - Orange line for high temperatures âœ…
  - Blue line for low temperatures (daily forecast) âœ…
  - Single line for hourly forecast âœ…
  - Colored dots at each data point âœ…
  - Professional TV weather broadcast appearance âœ…

### 6. Forecast Periods (User Selectable)
- [x] **Daily forecasts**: 5 or 7 days âœ…
- [x] **Hourly forecasts**: 1-48 hours (configurable) âœ…
- [x] Switchable forecast type (daily/hourly) âœ…

### 7. Animated Weather Icons (Meteocons by Bas Milius)
- [x] **Professional Icons**: Using Meteocons library - 236+ hand-crafted SVG weather icons âœ…
- [x] **Built-in Animations**: Smooth, professional animations designed by illustrator âœ…
- [x] **Comprehensive Coverage**: Sun, clouds, rain, snow, storms, fog, wind, and more âœ…
- [x] **Weather Conditions**: Clear day/night, partly cloudy, cloudy, rain, drizzle, snow, sleet, hail, thunderstorms, fog, wind âœ…
- [x] **Moon phases**: 8 accurate phase icons (new_moon, waxing_crescent, first_quarter, waxing_gibbous, full_moon, waning_gibbous, last_quarter, waning_crescent) âœ…
- [x] **Dynamic moon display**: Clear night icons automatically show current moon phase âœ…
- [x] **MIT Licensed**: Free to use, professionally maintained âœ…

### 8. Day/Night Theme Features
- [x] **Auto Day/Night Mode**: Automatically switches to darker starry theme at night âœ…
- [x] **Starry background**: Animated floating stars effect âœ…
- [x] **Dimmed colors**: Temperature gradients still visible but darker (40% brightness) âœ…
- [x] **Sunrise/sunset detection**: Uses sun.sun entity for accurate day/night timing âœ…
- [x] **Toggle control**: Enable/disable in editor âœ…
- [x] **Holiday Themes**: Automatic festive decorations during holidays âœ…
  - ğŸƒ Halloween (Oct 25-31): Pumpkins, ghosts, bats, spiders
  - ğŸ„ Christmas (Dec 18-25): Trees, snowmen, Santa, snowflakes
  - ğŸ† New Year (Dec 31 - Jan 1): Fireworks, confetti, celebration
  - â¤ï¸ Valentine's Day (Feb 13-14): Hearts, roses, love
  - ğŸ€ St. Patrick's Day (Mar 17): Shamrocks, rainbows, green
  - ğŸ° Easter (Late Mar - Early Apr): Bunnies, eggs, flowers, chicks
  - ğŸ‡ºğŸ‡¸ 4th of July (Jul 4): American flag, fireworks, stars
  - ğŸ‡²ğŸ‡½ Cinco de Mayo (May 5): Mexican flag, tacos, cacti, celebration
  - Subtle animated icon overlays (4 icons per holiday)
  - Floating animation effect
  - Semi-transparent (30-50% opacity)
  - Toggle on/off in Display Options
- [x] **Pre-built Themes**: 5 professional visual themes + custom âœ…
  - Retro/Neubrutalism: Bold colors, thick 4px borders, sharp corners, hard shadows
  - Midnight: Pure dark theme with near-black backgrounds (#0d0d0d), grayscale palette, no boxes on weather info, perfect for OLED displays and dark mode
  - Minimal: Clean white, simple monochrome, thin borders, subtle grayscale
  - Vibrant: Bright gradient backgrounds, saturated colors, high energy
  - Custom: User-defined colors (primary, secondary, background, text, border, accent)

### 9. Smart Alerts & Contextual Notifications
- [x] **NWS Alerts Integration**: Real-time weather warnings from National Weather Service âœ…
  - Direct API integration (no plugin required) âœ…
  - All alert types: hurricanes, tornadoes, thunderstorms, heat advisories, flood warnings, etc. âœ…
  - Severity color coding: Red (Extreme), Orange (Severe), Yellow (Moderate), Blue (Minor) âœ…
  - Location-based using Home Assistant coordinates âœ…
  - Auto-updates every 5 minutes with caching âœ…
  - Auto-hide when no active alerts âœ…
  - Shows event name, affected area, headline, and expiration time âœ…
- [x] **Rain Timing Notifications**: Smart precipitation alerts âœ…
  - Monitors next 4 hours of hourly forecast âœ…
  - Detects rain via precipitation probability (>50%) or rainy conditions âœ…
  - Broadcast-style lower third banner design âœ…
  - Shows time until rain and expected arrival time âœ…
  - Auto-hides when no rain expected âœ…
  - Works regardless of daily/hourly display mode (fetches hourly data separately) âœ…
  - Shimmer animation effect for professional look âœ…
  - Night mode support with darker gradient âœ…
  - Example: "â˜” Rain expected in 2 hours (~4:15 PM)" âœ…
- [ ] Air Quality integration (requires AQI sensor - future enhancement)
- [ ] "Best time to go outside today" suggestions (future enhancement)
- [ ] Pollen count alerts (future enhancement)

### 10. Sun & Moon Entity Integration
- [x] **Sun entity support**: Uses sun.sun for day/night detection and sunrise/sunset times âœ…
- [x] **Moon phase sensor**: Integrates sensor.moon_phase for accurate lunar phase display âœ…
- [x] **Auto-detection**: Automatically finds standard entities âœ…
- [x] **Custom overrides**: Optional sun_entity and moon_entity config for custom entities âœ…
- [x] **Graceful fallbacks**: Works without entities (falls back to time-based detection) âœ…

### 11. Configuration & Compatibility
- [x] Compatible with new Home Assistant dashboards âœ…
- [x] Visual editor for easy configuration âœ…
- [x] YAML configuration support âœ…
- [x] HACS installation support âœ…
- [x] Responsive design (mobile/tablet/desktop) âœ…
- [x] Performance optimized (efficient updates) âœ…

---

## Technical Stack

### Core Technologies
- **TypeScript**: Type-safe development
- **Lit**: Modern web components framework
- **CSS3**: Animations and theming
- **Home Assistant Frontend**: Card framework integration

### Build & Distribution
- **Rollup/Webpack**: Bundling
- **NPM**: Package management
- **GitHub**: Version control
- **HACS**: Distribution platform

---

## Project Phases

### Phase 1: Foundation (MVP) âœ… COMPLETE
- [x] Project structure setup âœ…
- [x] Basic card rendering âœ…
- [x] Weather entity integration âœ…
- [x] Simple current weather display âœ…
- [x] Basic 5-day forecast with horizontal bars âœ…
- [x] Temperature-based header highlighting âœ…
- [x] HACS configuration âœ…

### Phase 2: Core Features âœ… COMPLETE
- [x] All view modes (compact/standard/detailed) âœ…
- [x] All header modes (including greeting mode) âœ…
- [x] Dual temperature display âœ…
- [x] Daily forecast (5/7 days) âœ…
- [x] Hourly forecast (1-48 hours) âœ…
- [x] Animated weather icons âœ…
- [x] Visual configuration editor âœ…
- [x] Small AM/PM styling on all header modes âœ…

### Phase 3: Advanced Features âœ… COMPLETE
- [x] Weather information display system (UV, Wind, Feels Like, Humidity, Pressure, Visibility, Sunrise/Sunset) âœ…
- [x] Three weather info layout modes (compact, standard, detailed) âœ…
- [x] Moon phase display with 8 accurate phases âœ…
- [x] Auto day/night mode with starry theme âœ…
- [x] Sunrise/sunset times with auto-switching âœ…
- [x] NWS weather alerts integration âœ…
- [x] Professional Meteocons weather icons (236+ icons) âœ…
- [x] Rain timing notifications with broadcast-style banner âœ…
- [x] All 5 pre-built themes + custom theme support âœ…
- [x] Chart view mode (TV-style temperature trend lines) âœ…
- [x] Holiday decorations (8 holidays) âœ…

### Phase 4: Polish & Release
- Performance optimization
  - [x] **Reduce unnecessary renders:** In `shouldUpdate`, compare only relevant state/attribute changes to avoid re-rendering the card when not needed. Use `@state()` only for properties that affect rendering. âœ…
  - [x] **Debounce/throttle data fetches:** For methods like `fetchForecast` and `fetchNWSAlerts`, ensure you don't fetch more often than needed. Use debouncing or throttling if user interaction can trigger fetches. âœ…
  - [x] **Memoize expensive calculations:** Cache results of functions like `getWeatherData()` if the underlying entity hasn't changed, to avoid recalculating on every render. âœ…
  - [x] **Minimize inline styles:** Move as much styling as possible to the static `styles` block for better performance and easier theming. Avoid inline `style` attributes in templates. âœ…
  - [x] **Split large methods:** Break up large methods (like `renderHeader` and `renderWeatherInfo`) into smaller, focused helper methods for readability and maintainability. âœ…
  - [x] **Use optional chaining and nullish coalescing:** Ensure these are used everywhere to avoid runtime errors when accessing deeply nested properties. âœ…
  - [x] **Remove legacy fallbacks:** If only supporting new Home Assistant models, remove any legacy attribute fallbacks for clarity and maintainability. âœ…
  - [x] **Avoid unnecessary state:** Only use `@state()` for properties that must trigger a re-render. Use regular class properties for others. âœ…
  - **Optimize CSS:** Use CSS variables for theme colors, avoid deeply nested selectors, and prefer flat, efficient selectors for better performance.
    - Sub-tasks:
      1. âœ… Extract hardcoded colors to CSS variables (foundation for theming)
      2. âœ… Optimize night mode CSS using CSS variables
      3. âœ… Consolidate duplicate CSS rules (utility classes added for gradual adoption)
      4. Simplify deeply nested selectors to flat selectors
  - **Improve accessibility:** Add `aria-labels` and roles to important elements, and ensure keyboard navigation is supported for better accessibility.
- Comprehensive documentation
- Example configurations
- Testing across HA versions
- Community feedback integration
- GitHub release & HACS submission

---

## Configuration Example (Target)

```yaml
type: custom:weatherpulse-card
entity: weather.home
outdoor_temp_sensor: sensor.outdoor_temperature
header_mode: greeting
greeting_name: Sarah
show_date: true
show_time: true
forecast_days: 7
view_mode: standard
theme: midnight
animate_icons: true
data_rows:
  - temperature
  - precipitation
  - wind
  - uv_index
alerts:
  - weather_warnings
  - rain_timing
  - best_time_outside
custom_colors:
  cold: "#4A90E2"
  warm: "#F5A623"
  hot: "#E24A4A"
```

---

## Notes
- All features should be opt-in/configurable
- Performance is critical - card should load quickly
- Accessibility considerations for all visual elements
- Mobile-first responsive design
- Follow Home Assistant design guidelines

### Holiday Overlay Design (Foreground/Background)
- Each holiday has a main foreground icon (e.g., grave for Halloween, tree for Christmas) that is larger and in lower left in the header.
- Additional foreground icons (e.g., pumpkin, candy) are smaller and clustered/overlapped around the main icon in the header, creating a festive badge/group effect.
- Background icons (e.g., bats, spiders, ghosts) are animated, floating, and randomly placed around the card but we should put some thought has to what shows where and when we have lots of icons maybe not show all at once rotate thru them
- This approach provides a strong, festive cluster in the header while keeping playful, animated effects around the card.
- The foreground/background split is defined per holiday in the decorations object, allowing for easy customization and a polished look.

### Holiday Overlay Icon Groups
For each holiday, the following icons are used:

- **Halloween**
  - Foreground: ğŸª¦ (main), ğŸƒ, ğŸ¬
  - Background: ğŸ¦‡, ğŸ§™â€â™€ï¸, ğŸ•·ï¸, ğŸ‘», ğŸ•¸ï¸, ğŸ©¸, ğŸ¦¹â€â™‚ï¸, ğŸ§›, ğŸ§Ÿ
- **Christmas**
  - Foreground: ğŸ„ (main), ğŸ, ğŸ§¦, ğŸ•¯ï¸
  - Background: â„ï¸, ğŸ””, ğŸ¦Œ, ğŸ…, â›„, ğŸŒŸ, ğŸ§‘â€ğŸ„, ğŸ•¯ï¸
- **New Year**
  - Foreground: ğŸ† (main), ğŸ¥³, ğŸ¾, ğŸ¥‚
  - Background: ğŸ‡, ğŸ‰, âœ¨, ğŸŠ
- **Valentine's Day**
  - Foreground: ğŸ’ (main), ğŸŒ¹, ğŸ’Œ
  - Background: â¤ï¸, ğŸ’•, ğŸ’˜, ğŸ’–
- **St. Patrick's Day**
  - Foreground: ğŸ€ (main), â˜˜ï¸, ğŸ»
  - Background: ğŸŒˆ, ğŸ’š, ğŸ©, ğŸª™
- **4th of July**
  - Foreground: ğŸ‡ºğŸ‡¸ (main), ğŸ—½, ğŸ†
  - Background: ğŸ‡, â­, ğŸ‰, ğŸŠ
- **Easter**
  - Foreground: ğŸ° (main), ğŸ¥š, ğŸ‡
  - Background: ğŸŒ·, ğŸ£, ğŸ’, ğŸŒ¸
- **Cinco de Mayo**
  - Foreground: ğŸ‡²ğŸ‡½ (main), ğŸŒ®, ğŸ¹
  - Background: ğŸŒµ, ğŸ‰, ğŸŠ, ğŸº

This structure ensures each holiday has a visually strong, festive cluster in the header (foreground) and playful animated icons around the card (background).

### Holiday Theme Fixes & Enhancements (In Progress)
- [x] **Fix foreground cluster positioning**: Main holiday icons (foreground) now appear in lower left of header âœ…
  - [x] Add `position: relative` to `.card-header` base style âœ…
  - [x] Fix night mode override forcing `position: relative` on cluster âœ…
  - [x] Horizontal layout with main icon centered, flanking icons overlapping âœ…
  - [x] Positioned at `bottom: 8px; left: 8px` in both day and night modes âœ…
- [x] **Fix z-index layering**: Holiday icons now behind weather icon âœ…
  - [x] Lower `.holiday-foreground-cluster` z-index to 0 âœ…
  - [x] Weather icon remains prominent and visible âœ…
- [x] **Clean up duplicate CSS**: Removed redundant/unused holiday styles âœ…
  - [x] Remove duplicate `@keyframes holiday-float` definitions âœ…
  - [x] Remove unused `.holiday-icon-1` through `.holiday-icon-4` classes âœ…
  - [x] Replace orange glow with subtle shadow on all holiday icons âœ…
- [x] **Improve background icon placement**: Strategic positioning instead of all random âœ…
  - [x] Create placement zones for background icons (top, sides, corners) âœ…
  - [x] Implement icon rotation system (time-based, cycles every 10 seconds) âœ…
  - [x] Custom layouts per holiday with specific placements âœ…
  - [x] Reduce visual clutter while maintaining festive feel âœ…
- [x] **Add string lights decoration**: Holiday light strings across header âœ…
  - [x] Christmas: Long traditional bulb style âœ…
  - [x] Other holidays: Round bulb style with holiday-specific colors âœ…
    - Halloween: Orange and purple bulbs âœ…
    - Valentine's: Pink and red bulbs âœ…
    - St. Patrick's: Green and gold bulbs âœ…
    - 4th of July: Red, white, and blue bulbs âœ…
    - New Year: Gold and silver bulbs âœ…
    - Easter: Pastel colored bulbs âœ…
    - Cinco de Mayo: Mexican flag colors âœ…
  - [x] 12 lights per holiday stretching edge-to-edge âœ…
  - [x] Visible connecting wire across top âœ…
  - [x] Pulsing glow/shimmer animation âœ…
  - [x] Valentine's, St. Patrick's, and Easter omit lights (not needed) âœ…
- [x] **Create custom layouts for each holiday**: Holiday-specific icon placements âœ…
  - [x] **Halloween**: Witch/vampire/zombie rotation, 2 bats, 2 spiders, ghost, web âœ…
  - [x] **Christmas**: Santa/Elf rotation, 2 snowflakes, 2 stars, reindeer, snowman âœ…
  - [x] **New Year**: 2 fireworks, 2 sparkles, 2 party poppers âœ…
  - [x] **Valentine's**: All 5 heart types distributed across header âœ…
  - [x] **4th of July**: 2 fireworks, 2 stars, party popper, confetti âœ…
  - [x] **St. Patrick's**: 2 rainbows, green heart, leprechaun hat, gold coin âœ…
  - [x] **Easter**: 2 tulips, hatching chick, bouquet, cherry blossom âœ…
  - [x] **Cinco de Mayo**: 2 cacti, trumpet, party popper, confetti âœ…
- [ ] **Test all holidays**: Verify both day and night modes work correctly
  - [x] Halloween (Oct 25-31) - Tested âœ…
  - [ ] Christmas (Dec 18-25)
  - [ ] New Year (Dec 31 - Jan 1)
  - [ ] Valentine's Day (Feb 13-14)
  - [ ] St. Patrick's Day (Mar 17)
  - [ ] Easter (Late Mar - Early Apr)
  - [ ] 4th of July (Jul 4)
  - [ ] Cinco de Mayo (May 5)

### Future Alert Enhancements
- [ ] **Rain timing visual overlay**: When rain is detected in next few hours, add animated rain effect over header
  - Visual rain animation cascading down the header
  - Works with existing rain timing alert banner
  - Could be extended to other alert types (snow, storm, etc.)
